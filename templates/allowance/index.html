{% extends "base.html" %} 
{% from "macros.jinja" import window_vars with context %}

{% block page %}
<div class="row q-col-gutter-md" id="vue" data-cy="allowance-extension">
  <div class="col-12 col-md-7 q-gutter-y-md">
    <q-card>
      <q-card-section>
        <q-btn unelevated color="primary" @click="openCreateDialog" icon="add" data-cy="new-allowance-btn"
          >New Allowance</q-btn
        >
      </q-card-section>
    </q-card>

    <q-card>
      <q-card-section>
        <div class="row items-center no-wrap q-mb-md">
          <div class="col">
            <h5 class="text-subtitle1 q-my-none">Allowances</h5>
          </div>
          <div class="col-auto">
            <q-btn
              flat
              color="grey"
              @click="exportCSV"
              icon="file_download"
              size="sm"
              ><q-tooltip>Export to CSV</q-tooltip></q-btn
            >
          </div>
        </div>
        <q-table
          dense
          flat
          :rows="allowances"
          :columns="allowanceTable.columns"
          row-key="id"
          v-model:pagination="allowanceTable.pagination"
        >
          <template v-slot:header="props">
            <q-tr class="text-left" :props="props">
              <q-th v-for="col in props.cols" :key="col.name" :props="props">
                <span v-text="col.label"></span>
              </q-th>
              <q-th auto-width></q-th>
            </q-tr>
          </template>
          <template v-slot:body="props">
            <q-tr :props="props">
              <q-td v-for="col in props.cols" :key="col.name" :props="props">
                <span v-if="col.name == 'id'">
                  <q-btn
                    flat
                    size="xs"
                    color="grey"
                    dense
                    @click="copyText(col.value)"
                    icon="content_copy"
                    class="q-mr-sm"
                  >
                    <q-tooltip>Copy ID</q-tooltip>
                  </q-btn>
                  <span v-text="col.value"></span>
                </span>
                <span v-else-if="col.name == 'amount'">
                  <span v-text="col.value"></span> <span v-text="props.row.currency || 'sats'"></span>
                </span>
                <span v-else-if="col.name == 'status'">
                  <q-badge
                    :color="props.row.active ? 'positive' : 'grey'"
                    :label="props.row.active ? 'Active' : 'Inactive'"
                  />
                </span>
                <span v-else v-text="col.value"></span>
              </q-td>
              <q-td auto-width>
                <q-btn
                  flat
                  dense
                  size="xs"
                  @click="openUpdateDialog(props.row)"
                  icon="edit"
                  color="light-blue"
                  class="q-mr-xs"
                >
                  <q-tooltip>Edit allowance</q-tooltip>
                </q-btn>
                <q-btn
                  flat
                  dense
                  size="xs"
                  @click="openQrCodeDialog(props.row)"
                  icon="qr_code"
                  color="grey"
                  class="q-mr-xs"
                >
                  <q-tooltip>Show QR Code</q-tooltip>
                </q-btn>
                <q-btn
                  flat
                  dense
                  size="xs"
                  @click="deleteAllowance(props.row.id)"
                  icon="cancel"
                  color="pink"
                >
                  <q-tooltip>Delete allowance</q-tooltip>
                </q-btn>
              </q-td>
            </q-tr>
          </template>
        </q-table>
      </q-card-section>
    </q-card>
  </div>

  <div class="col-12 col-md-5 q-gutter-y-md">
    <q-card>
      <q-card-section>
        <h6 class="text-subtitle1 q-my-none">
          <q-icon size="1.2em" name="account_balance_wallet" class="q-mr-sm"></q-icon>
          Allowance Extension
        </h6>
        <p>
          Setup recurring payments to lightning addresses. Perfect for allowances, subscriptions, and regular transfers.
        </p>
      </q-card-section>
      <q-card-section class="q-pa-none">
        <q-separator></q-separator>
        <q-list>
          {% include "allowance/_api_docs.html" %}
          <q-separator></q-separator>
          <q-expansion-item
            expand-separator
            icon="help_outline"
            label="Usage Guide"
          >
            <q-card>
              <q-card-section>
                <p class="text-subtitle2 q-mb-sm">How to use Allowances:</p>
                <ol class="q-pl-md">
                  <li class="q-mb-sm">Create a new allowance by clicking "New Allowance"</li>
                  <li class="q-mb-sm">Set the recipient's Lightning address</li>
                  <li class="q-mb-sm">Configure the amount and currency</li>
                  <li class="q-mb-sm">Choose the payment frequency (daily, weekly, monthly)</li>
                  <li class="q-mb-sm">Set start and end dates for the allowance</li>
                  <li class="q-mb-sm">Save and activate the allowance</li>
                </ol>
                <q-separator class="q-my-md"></q-separator>
                <p class="text-caption text-grey-7">
                  Allowances will automatically send payments according to your schedule. 
                  You can pause, edit, or delete them at any time.
                </p>
              </q-card-section>
            </q-card>
          </q-expansion-item>
        </q-list>
      </q-card-section>
    </q-card>
  </div>

  <!-- CREATE/UPDATE ALLOWANCE DIALOG -->
  <q-dialog v-model="formDialog.show" position="top" @hide="closeFormDialog">
    <q-card class="q-pa-lg q-pt-xl" style="width: 500px">
      <q-form @submit.prevent="saveAllowance" class="q-gutter-md" ref="allowanceForm" no-error-focus>
        <div class="text-center q-mb-lg">
          <div class="text-h6">
            <span v-if="formDialog.data.id">Update</span>
            <span v-else>Create</span>
            Allowance
          </div>
        </div>
        
        <q-input
          filled
          dense
          v-model.trim="formDialog.data.name"
          label="Description *"
          placeholder="e.g., Weekly allowance for Alice"
          :rules="[val => !!val || 'Description is required']"
        ></q-input>
        
        <q-select
          filled
          dense
          v-model="formDialog.data.wallet"
          :options="g.user.wallets"
          option-label="name"
          option-value="id"
          emit-value
          map-options
          label="Wallet *"
          :rules="[val => !!val || 'Wallet is required']"
        >
          <q-tooltip>The wallet that will send the allowance payments</q-tooltip>
        </q-select>
        
        <q-input
          filled
          dense
          v-model.trim="formDialog.data.lightning_address"
          label="Lightning Address *"
          placeholder="alice@getalby.com"
          :rules="[
            val => !!val || 'Lightning address is required',
            val => val.includes('@') || 'Please enter a valid Lightning address'
          ]"
        >
          <q-tooltip>The Lightning address where payments will be sent</q-tooltip>
        </q-input>
        
        <div class="row q-gutter-sm">
          <div class="col">
            <q-input
              filled
              dense
              v-model.number="formDialog.data.amount"
              type="number"
              label="Amount *"
              :rules="[val => val > 0 || 'Amount must be greater than 0']"
              min="1"
              step="1"
            ></q-input>
          </div>
          <div class="col-auto" style="width: 100px">
            <q-select
              filled
              dense
              v-model="formDialog.data.currency"
              :options="['sats', 'USD', 'EUR']"
              label="Currency"
            ></q-select>
          </div>
        </div>
        
        <q-select
          filled
          dense
          v-model="formDialog.data.frequency_type"
          :options="frequencyOptions"
          label="Frequency *"
          option-label="label"
          option-value="value"
          emit-value
          map-options
          :rules="[val => !!val || 'Frequency is required']"
        ></q-select>
        
        <div class="row q-gutter-sm">
          <div class="col">
            <q-input
              filled
              dense
              v-model="formDialog.data.start_date"
              label="Start Date *"
              type="date"
              :rules="[val => !!val || 'Start date is required']"
            ></q-input>
          </div>
          <div class="col">
            <q-input
              filled
              dense
              v-model="formDialog.data.end_date"
              label="End Date (Optional)"
              type="date"
            ></q-input>
          </div>
        </div>
        
        <q-toggle
          v-model="formDialog.data.active"
          label="Active"
          color="positive"
        />
        
        <div class="row q-mt-lg">
          <q-btn
            v-close-popup
            flat
            color="grey"
            class="q-ml-auto"
            >Cancel</q-btn
          >
          <q-btn
            unelevated
            color="primary"
            :loading="formDialog.loading"
            type="submit"
            class="q-ml-sm"
            >
            <span v-if="formDialog.data.id">Update</span>
            <span v-else>Create</span>
            Allowance
          </q-btn
          >
        </div>
      </q-form>
    </q-card>
  </q-dialog>
  
  <!-- QR CODE DIALOG -->
  <q-dialog v-model="qrCodeDialog.show" position="top">
    <q-card class="q-pa-lg">
      <div class="text-center">
        <div class="text-h6 q-mb-lg">Allowance QR Code</div>
        <q-responsive :ratio="1" class="q-mx-md" style="max-width: 300px">
          <qrcode
            :value="qrCodeDialog.data.lnurl"
            :options="{width: 800}"
            class="rounded-borders"
          ></qrcode>
        </q-responsive>
        <div class="q-mt-lg">
          <q-btn
            outline
            color="grey"
            @click="copyText(qrCodeDialog.data.lnurl)"
            icon="content_copy"
            >Copy LNURL</q-btn
          >
        </div>
      </div>
    </q-card>
  </q-dialog>
</div>
{% endblock %} 

{% block scripts %} 
{{ window_vars(user) }}
<script src="/allowance/static/js/allowance.js"></script>
{% endblock %}