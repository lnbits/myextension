{% extends "base.html" %} 
{% from "macros.jinja" import window_vars with context %}

{% block page %}
<div class="row q-col-gutter-md" id="vue">
  <div class="col-12 col-md-8 col-lg-7 q-gutter-y-md">
    <q-card>
      <q-card-section>
        <q-btn unelevated color="primary" @click="formDialog.show = true"
          >Create Allowance</q-btn
        >
      </q-card-section>
    </q-card>

    <q-card>
      <q-card-section>
        <div class="row items-center no-wrap q-mb-md">
          <div class="col">
            <h5 class="text-subtitle1 q-my-none">Allowances</h5>
          </div>
        </div>
        <q-table
          dense
          flat
          :data="allowances"
          row-key="id"
          :columns="allowanceTable.columns"
          :pagination.sync="allowanceTable.pagination"
        >
          <template v-slot:body="props">
            <q-tr :props="props">
              <q-td v-for="col in props.cols" :key="col.name" :props="props">
                <div v-if="col.field == 'amount'">${ col.value } ${ props.row.currency }</div>
                <div v-else>${ col.value }</div>
              </q-td>
              <q-td auto-width>
                <q-btn
                  flat
                  dense
                  size="xs"
                  @click="deleteAllowance(props.row.id)"
                  icon="cancel"
                  color="pink"
                >
                  <q-tooltip>Delete allowance</q-tooltip>
                </q-btn>
              </q-td>
            </q-tr>
          </template>
        </q-table>
      </q-card-section>
    </q-card>
  </div>

  <div class="col-12 col-md-4 col-lg-5 q-gutter-y-md">
    <q-card>
      <q-card-section>
        <h6 class="text-subtitle1 q-my-none">
          Allowance Extension
        </h6>
        <p>
          Setup recurring payments to lightning addresses. Perfect for allowances, subscriptions, and regular transfers.
        </p>
      </q-card-section>
    </q-card>
  </div>

  <!-- Create Allowance Dialog -->
  <q-dialog v-model="formDialog.show" position="top" @hide="closeFormDialog">
    <q-card class="q-pa-lg q-pt-xl" style="width: 500px">
      <q-form @submit="createAllowance" class="q-gutter-md">
        <q-input
          filled
          dense
          v-model.trim="formDialog.data.name"
          label="Allowance Name *"
          placeholder="Weekly allowance"
          :rules="[val => val && val.length > 0 || 'Name is required']"
        ></q-input>
        
        <q-select
          filled
          dense
          emit-value
          v-model="formDialog.data.wallet"
          :options="g.user && g.user.walletOptions ? g.user.walletOptions : []"
          label="Source Wallet *"
          :rules="[val => val || 'Wallet is required']"
        ></q-select>

        <q-input
          filled
          dense
          v-model.trim="formDialog.data.lightning_address"
          label="Lightning Address *"
          placeholder="user@domain.com"
          hint="Lightning address (like user@domain.com) or LNURL-pay link"
          :rules="[val => val && val.length > 0 || 'Lightning address is required']"
        ></q-input>

        <div class="row q-gutter-sm">
          <div class="col-8">
            <q-input
              filled
              dense
              type="number"
              v-model.number="formDialog.data.amount"
              label="Amount *"
              placeholder="1000"
              hint="Amount to send with each payment"
              :rules="[val => val > 0 || 'Amount must be greater than 0']"
            ></q-input>
          </div>
          <div class="col">
            <q-select
              filled
              dense
              emit-value
              v-model="formDialog.data.currency"
              :options="[
                {label: 'Sats', value: 'sats'},
                {label: 'GBP', value: 'GBP'},
                {label: 'USD', value: 'USD'},
                {label: 'EUR', value: 'EUR'},
                {label: 'JPY', value: 'JPY'},
                {label: 'CAD', value: 'CAD'},
                {label: 'AUD', value: 'AUD'}
              ]"
              label="Currency *"
            ></q-select>
          </div>
        </div>

        <q-select
          filled
          dense
          emit-value
          v-model="formDialog.data.frequency_type"
          :options="[
            {label: 'Daily', value: 'daily'},
            {label: 'Weekly', value: 'weekly'},
            {label: 'Monthly', value: 'monthly'},
            {label: 'Yearly', value: 'yearly'}
          ]"
          label="Frequency *"
          :rules="[val => val || 'Frequency is required']"
        ></q-select>

        <q-input
          filled
          dense
          v-model.trim="formDialog.data.memo"
          label="Memo"
          placeholder="Optional memo for payments"
        ></q-input>

        <div class="row q-mt-lg">
          <q-btn
            unelevated
            color="primary"
            type="submit"
            :disable="!isFormValid"
            >Create Allowance</q-btn
          >
          <q-btn v-close-popup flat color="grey" class="q-ml-auto"
            >Cancel</q-btn
          >
        </div>
      </q-form>
    </q-card>
  </q-dialog>
</div>
{% endblock %} 

{% block scripts %} 
{{ window_vars(user) }}
<script src="{{ static_url_for('allowance/static', path='js/index.js') }}"></script>
{% endblock %}